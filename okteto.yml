build:
  cli:
    context: .
    dockerfile: Dockerfile
    args:
      VERSION_STRING: $OKTETO_GIT_COMMIT
deploy:
  remote: true
  context: .
  image: $OKTETO_BUILD_CLI_IMAGE
  commands:
  - name: CLI
    command: /usr/local/bin/okteto version
dev:
  cli:
    image: okteto/golang:1
    command: bash
    workdir: /usr/src/cli
    sync:
      - .:/usr/src/cli
    volumes:
      - /go/pkg/
      - /root/.cache/go-build/
    autocreate: true
test:
  unit:
    image: okteto/golang:1
    context: .
    commands:
      - go test ./pkg/... -v
    artifacts:
      - coverage.out
    caches:
      - /go/pkg
      - /root/.cache/go-build
  integration:
    image: okteto/golang:1
    context: .
    commands:
      - go test ./integration/... -v
    artifacts:
      - integration-results.log
    caches:
      - /go/pkg
      - /root/.cache/go-build
  cves:
    image: aquasec/trivy:latest
    context: .
    commands:
      - trivy image --severity HIGH,CRITICAL --output trivy-results.txt $OKTETO_BUILD_CLI_IMAGE
    artifacts:
      - trivy-results.txt
